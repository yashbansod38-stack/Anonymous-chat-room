rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ────────────────────────────────────────

    // Check if request is from an authenticated user
    function isAuth() {
      return request.auth != null;
    }

    // Check if the requester is the document owner
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Check if a user is an admin (store admin UIDs in /admins/{uid})
    function isAdmin() {
      return isAuth() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Check if a user is a participant of a chat
    function isChatParticipant(chatId) {
      let chat = get(/databases/$(database)/documents/chats/$(chatId));
      return isAuth() && (
        request.auth.uid in chat.data.participants
      );
    }

    // Prevent a specific field from being changed
    function fieldUnchanged(field) {
      return !(field in request.resource.data) ||
             request.resource.data[field] == resource.data[field];
    }

    // ─── /users/{userId} ─────────────────────────────────────────

    match /users/{userId} {
      // Anyone authenticated can read user profiles (needed for matching)
      allow read: if isAuth();

      // Users can create their own profile
      allow create: if isOwner(userId) &&
        request.resource.data.userId == userId &&
        request.resource.data.violationCount == 0 &&
        request.resource.data.isBlocked == false;

      // Users can update their own profile with restrictions:
      //  - violationCount can only go UP (increment by 1, never decrease)
      //  - isBlocked can only go from false → true (self-ban), never true → false
      //  - userId is immutable
      allow update: if isOwner(userId) &&
        fieldUnchanged('userId') &&
        // violationCount: must stay same OR increase by exactly 1
        (fieldUnchanged('violationCount') ||
         request.resource.data.violationCount == resource.data.violationCount + 1) &&
        // isBlocked: must stay same OR change from false to true
        (fieldUnchanged('isBlocked') ||
         (resource.data.isBlocked == false && request.resource.data.isBlocked == true));

      // Admins can update any user (for manual banning, unbanning, resets)
      allow update: if isAdmin();

      // No one can delete users
      allow delete: if false;
    }

    // ─── /chats/{chatId} ─────────────────────────────────────────

    match /chats/{chatId} {
      // Only participants can read their chat
      allow read: if isChatParticipant(chatId) || isAdmin();

      // Authenticated users can create chats (matchmaking creates these)
      allow create: if isAuth() &&
        request.auth.uid in request.resource.data.participants;

      // Only participants can update chat status (e.g., ending the chat)
      allow update: if isChatParticipant(chatId);

      // No deletion
      allow delete: if isAdmin();

      // ─── /chats/{chatId}/messages/{messageId} ──────────────────

      match /messages/{messageId} {
        // Only chat participants can read messages
        allow read: if isChatParticipant(chatId) || isAdmin();

        // Only chat participants can create messages
        // Sender must be the authenticated user
        allow create: if isChatParticipant(chatId) &&
          request.resource.data.senderId == request.auth.uid;

        // Messages cannot be updated or deleted (prevent overwriting)
        allow update: if false;
        allow delete: if isAdmin();
      }
    }

    // ─── /reports/{reportId} ─────────────────────────────────────

    match /reports/{reportId} {
      // Only admins can read reports
      allow read: if isAdmin();

      // Authenticated users can create reports (file a report)
      allow create: if isAuth() &&
        request.resource.data.reporterId == request.auth.uid &&
        request.resource.data.status == 'pending';

      // Only admins can update reports (review, resolve, dismiss)
      allow update: if isAdmin();

      // No deletion
      allow delete: if false;
    }

    // ─── /violations/{violationId} ───────────────────────────────

    match /violations/{violationId} {
      // Only admins can read violations
      allow read: if isAdmin();

      // Only server / admin can create violations
      allow create: if isAdmin();

      // No updates or deletes
      allow update: if false;
      allow delete: if false;
    }

    // ─── /matchQueue/{queueId} ───────────────────────────────────

    match /matchQueue/{queueId} {
      // Users can read the queue to find matches
      allow read: if isAuth();

      // Authenticated users can add themselves to the queue
      allow create: if isAuth() &&
        request.resource.data.userId == request.auth.uid;

      // Users can update their own queue entry (cancel, match)
      allow update: if isAuth() &&
        resource.data.userId == request.auth.uid;

      // Allow match partner to update status when matched
      allow update: if isAuth();

      // Users can delete their own queue entry (cancel search)
      allow delete: if isAuth() &&
        resource.data.userId == request.auth.uid;
    }

    // ─── /connections/{connectionId} ─────────────────────────────

    match /connections/{connectionId} {
      // Only involved users can read their connections
      allow read: if isAuth() && (
        request.auth.uid in resource.data.users
      );

      // Authenticated users can create connections
      allow create: if isAuth() &&
        request.auth.uid in request.resource.data.users;

      // No modification after creation
      allow update: if false;
      allow delete: if false;
    }

    // ─── /connectionRequests/{requestId} ─────────────────────────

    match /connectionRequests/{requestId} {
      // Sender or receiver can read
      allow read: if isAuth() && (
        request.auth.uid == resource.data.fromUserId ||
        request.auth.uid == resource.data.toUserId
      );

      // Authenticated users can create requests (as sender)
      allow create: if isAuth() &&
        request.resource.data.fromUserId == request.auth.uid &&
        request.resource.data.status == 'pending';

      // Only the receiver can update (accept/decline)
      allow update: if isAuth() &&
        resource.data.toUserId == request.auth.uid;

      // No deletion
      allow delete: if false;
    }

    // ─── /admins/{uid} ───────────────────────────────────────────
    // Admin whitelist — manually managed, no client writes

    match /admins/{uid} {
      allow read: if isAuth();
      allow write: if false;
    }

    // ─── Catch-all: deny everything else ─────────────────────────

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
